<!DOCTYPE html>
<html lang="en-us">

<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
  <meta http-equiv="X-Clacks-Overhead" content="GNU Terry Pratchett" />
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
<link rel="shortcut icon" href="http://localhost:1313/favicon.ico" />
<title>Background Job Scheduling using Hangfire | Muhammad Azeez</title>
<meta name="title" content="Background Job Scheduling using Hangfire" />
<meta name="description" content="
Note: This post is part of C# Advent Calendar 2020.

Sometimes you&rsquo;ve tasks that would take too much time to do in the request-response model. For example sending multiple emails. So you have to send the emails asynchronously (i.e. in the background) and returning a response before the jobs are done. Or maybe you want to do some task periodically. For example generating a resource-intensive report at midnight or sending monthly invoices to customers. In short, you want to be able to schedule jobs and be able to track their progress and see their results." />
<meta name="keywords" content="hangfire," />


<meta property="og:url" content="http://localhost:1313/posts/background-job-scheduling-using-hangfire/">
  <meta property="og:site_name" content="Muhammad Azeez">
  <meta property="og:title" content="Background Job Scheduling using Hangfire">
  <meta property="og:description" content="Note: This post is part of C# Advent Calendar 2020.
Sometimes you’ve tasks that would take too much time to do in the request-response model. For example sending multiple emails. So you have to send the emails asynchronously (i.e. in the background) and returning a response before the jobs are done. Or maybe you want to do some task periodically. For example generating a resource-intensive report at midnight or sending monthly invoices to customers. In short, you want to be able to schedule jobs and be able to track their progress and see their results.">
  <meta property="og:locale" content="en_us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2020-12-05T00:00:00+00:00">
    <meta property="article:modified_time" content="2020-12-05T00:00:00+00:00">
    <meta property="article:tag" content="Hangfire">
    <meta property="og:image" content="http://localhost:1313/assets/images/cover.jpg">




  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:image" content="http://localhost:1313/assets/images/cover.jpg">
  <meta name="twitter:title" content="Background Job Scheduling using Hangfire">
  <meta name="twitter:description" content="Note: This post is part of C# Advent Calendar 2020.
Sometimes you’ve tasks that would take too much time to do in the request-response model. For example sending multiple emails. So you have to send the emails asynchronously (i.e. in the background) and returning a response before the jobs are done. Or maybe you want to do some task periodically. For example generating a resource-intensive report at midnight or sending monthly invoices to customers. In short, you want to be able to schedule jobs and be able to track their progress and see their results.">




  <meta itemprop="name" content="Background Job Scheduling using Hangfire">
  <meta itemprop="description" content="Note: This post is part of C# Advent Calendar 2020.
Sometimes you’ve tasks that would take too much time to do in the request-response model. For example sending multiple emails. So you have to send the emails asynchronously (i.e. in the background) and returning a response before the jobs are done. Or maybe you want to do some task periodically. For example generating a resource-intensive report at midnight or sending monthly invoices to customers. In short, you want to be able to schedule jobs and be able to track their progress and see their results.">
  <meta itemprop="datePublished" content="2020-12-05T00:00:00+00:00">
  <meta itemprop="dateModified" content="2020-12-05T00:00:00+00:00">
  <meta itemprop="wordCount" content="674">
  <meta itemprop="image" content="http://localhost:1313/assets/images/cover.jpg">
  <meta itemprop="keywords" content="Hangfire">
<meta name="referrer" content="no-referrer-when-downgrade" />

  <style>
  :root {
    --width: 720px;
    --font-main: Verdana, sans-serif;
    --font-secondary: Verdana, sans-serif;
    --font-scale: 1em;
    --background-color: #fff;
    --heading-color: #222;
    --text-color: #444;
    --link-color: #3273dc;
    --visited-color: #8b6fcb;
    --blockquote-color: #222;
  }

  @media (prefers-color-scheme: dark) {
    :root {
      --background-color: #01242e;
      --heading-color: #eee;
      --text-color: #ddd;
      --link-color: #8cc2dd;
      --visited-color: #8b6fcb;
      --blockquote-color: #ccc;
    }
  }

  body {
    font-family: var(--font-secondary);
    font-size: var(--font-scale);
    margin: auto;
    padding: 20px;
    max-width: var(--width);
    text-align: left;
    background-color: var(--background-color);
    word-wrap: break-word;
    overflow-wrap: break-word;
    line-height: 1.5;
    color: var(--text-color);
  }

  h1,
  h2,
  h3,
  h4,
  h5,
  h6 {
    font-family: var(--font-main);
    color: var(--heading-color);
  }

  a {
    color: var(--link-color);
    cursor: pointer;
    text-decoration: none;
  }

  a:hover {
    text-decoration: underline;
  }

  nav a {
    margin-right: 8px;
  }

  strong,
  b {
    color: var(--heading-color);
  }

  button {
    margin: 0;
    cursor: pointer;
  }

  time {
    font-family: monospace;
    font-style: normal;
    font-size: 15px;
  }

  main {
    line-height: 1.6;
  }

  table {
    width: 100%;
  }

  hr {
    border: 0;
    border-top: 1px dashed;
  }

  img {
    max-width: 100%;
  }

  code {
    font-family: monospace;
    padding: 2px;
    border-radius: 3px;
  }

  blockquote {
    border-left: 1px solid #999;
    color: var(--blockquote-color);
    padding-left: 20px;
    font-style: italic;
  }

  footer {
    padding: 25px 0;
    text-align: center;
  }

  .title:hover {
    text-decoration: none;
  }

  .title h1 {
    font-size: 1.5em;
  }

  .inline {
    width: auto !important;
  }

  .highlight,
  .code {
    border-radius: 3px;
    margin-block-start: 1em;
    margin-block-end: 1em;
    overflow-x: auto;
  }

   
  ul.blog-posts {
    list-style-type: none;
    padding: unset;
  }

  ul.blog-posts li {
    display: flex;
  }

  ul.blog-posts li span {
    flex: 0 0 130px;
  }

  ul.blog-posts li a:visited {
    color: var(--visited-color);
  }

</style>
<link rel="stylesheet" href="/assets/css/highlight.css">
<link rel="stylesheet" href="/assets/css/override.css">
<script defer src="https://cdn.jsdelivr.net/npm/chart.js@4.4.6/dist/chart.umd.min.js"></script>
</head>

<body>
  <header><div class="site-brand site-brand--inline">
  <a href="/" class="title">
    <h2>Muhammad Azeez</h2>
  </a>
  <nav class="site-nav"><a href="/">Home</a>
<a href="/about/">About</a>
</nav>
</div>
</header>
  <main>

<content>
  <blockquote>
<p><strong>Note:</strong> This post is part of C# <a href="https://www.csadvent.christmas/">Advent Calendar 2020</a>.</p>
</blockquote>
<p>Sometimes you&rsquo;ve tasks that would take too much time to do in the request-response model. For example sending multiple emails. So you have to send the emails asynchronously (i.e. in the background) and returning a response before the jobs are done. Or maybe you want to do some task periodically. For example generating a resource-intensive report at midnight or sending monthly invoices to customers. In short, you want to be able to schedule jobs and be able to track their progress and see their results.</p>
<p>You can of course use an in-memory model and use ASP.NET Core&rsquo;s <a href="https://docs.microsoft.com/en-us/aspnet/core/fundamentals/host/hosted-services">IHostedService</a>. But then if the application restarts all of the scheduled jobs would be gone. So you need to persist the jobs so that they are not lost. And Maybe you want to have multiple workers (consumers) processing the background jobs and the works might be on different machines. And what about retrying jobs when they fail?</p>
<p><strong><a href="https://www.hangfire.io/">Hangfire</a></strong> is a library that helps you do all of that and more very easily. It&rsquo;s very popular and well tested. It&rsquo;s also customizable and supports different kinds of storage mechanisms. And it supports different styles and techniques of background job processing.</p>
<img src="/assets/images/posts/background-job-scheduling-using-hangfire/dashboard.jpg" width="800">
<h2 id="how-to-use-hangfire">How to use Hangfire</h2>
<p>We are going to host hangfire in an ASP.NET Core app and use SQLite for storage. You can also use MSSQL, PostgreSQL, MySQL and other database engines and host it in a console app. The <a href="https://docs.hangfire.io/en/latest/getting-started/aspnet-core-applications.html">official guide</a> is very good but here are the steps:</p>
<ol>
<li>
<p>Add these Nuget packages*:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span><span style="color:#062873;font-weight:bold">&lt;PackageReference</span> <span style="color:#4070a0">Include=</span><span style="color:#4070a0">&#34;Hangfire.Core&#34;</span> <span style="color:#4070a0">Version=</span><span style="color:#4070a0">&#34;1.7.18&#34;</span> <span style="color:#062873;font-weight:bold">/&gt;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span><span><span style="color:#062873;font-weight:bold">&lt;PackageReference</span> <span style="color:#4070a0">Include=</span><span style="color:#4070a0">&#34;Hangfire.AspNetCore&#34;</span> <span style="color:#4070a0">Version=</span><span style="color:#4070a0">&#34;1.7.18&#34;</span> <span style="color:#062873;font-weight:bold">/&gt;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span><span><span style="color:#062873;font-weight:bold">&lt;PackageReference</span> <span style="color:#4070a0">Include=</span><span style="color:#4070a0">&#34;Hangfire.Storage.SQLite&#34;</span> <span style="color:#4070a0">Version=</span><span style="color:#4070a0">&#34;0.2.4&#34;</span> <span style="color:#062873;font-weight:bold">/&gt;</span>
</span></span></code></pre></div></li>
<li>
<p>Add Hangfire to Dependency Container:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span><span style="color:#60a0b0;font-style:italic">// Add Hangfire services.</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span><span>services.AddHangfire(configuration =&gt; configuration
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span><span>    .SetDataCompatibilityLevel(CompatibilityLevel.Version_170)
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4</span><span>    .UseSimpleAssemblyNameTypeSerializer()
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5</span><span>    .UseRecommendedSerializerSettings()
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6</span><span>    .UseSQLiteStorage());
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8</span><span><span style="color:#60a0b0;font-style:italic">// Add the processing server as IHostedService</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">9</span><span>services.AddHangfireServer();
</span></span></code></pre></div></li>
<li>
<p>Define Hangfire Dashboard route:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span>app.UseEndpoints(endpoints =&gt;
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span><span>{
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span><span>    endpoints.MapRazorPages();
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4</span><span>    endpoints.MapHangfireDashboard();
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5</span><span>});
</span></span></code></pre></div></li>
</ol>
<p>Now you can run the app and go to <code>/hangfire</code> and see it. But there are no jobs yet.</p>
<h2 id="enqueuing-jobs">Enqueuing Jobs</h2>
<p>If you want to enqueue a job in a fire-and-forget fashion (i.e. you don&rsquo;t want to wait for the result and you don&rsquo;t care much about when exactly it&rsquo;s going to happen), you do something like this:</p>
<pre tabindex="0"><code>backgroundJobs.Enqueue(() =&gt; Console.WriteLine(&#34;Hello world from Hangfire!&#34;));
</code></pre><p>What if you wanted to something that might require some dependencies. For example you need a connection to the database or access to configurations? Well, then you can create a class for the job and get your dependencies through Dependency Injection:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span><span style="color:#007020;font-weight:bold">public</span> <span style="color:#007020;font-weight:bold">class</span> <span style="color:#0e84b5;font-weight:bold">SendEmailsJob</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span>{
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span>    <span style="color:#007020;font-weight:bold">public</span> SendEmailsJob(IConfiguration configuration)
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span>    {
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span>        <span style="color:#60a0b0;font-style:italic">// You can ask for configuration or any other</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span>        <span style="color:#60a0b0;font-style:italic">// dependency the job might need via Dependency Injection</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span><span>    }
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span><span><span style="color:#4070a0">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span><span><span style="color:#4070a0">    [JobDisplayName(&#34;Send {0} emails&#34;)]</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span><span><span style="color:#4070a0">    [AutomaticRetry(Attempts = 3)]</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span><span>    <span style="color:#007020;font-weight:bold">public</span> <span style="color:#007020;font-weight:bold">async</span> Task Execute(<span style="color:#902000">int</span> count)
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span><span>    {
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span><span>        <span style="color:#007020;font-weight:bold">for</span> (<span style="color:#902000">int</span> i = <span style="color:#40a070">0</span>; i &lt; count; i++)
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span><span>        {
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span><span>            <span style="color:#007020;font-weight:bold">await</span> Task.Delay(<span style="color:#40a070">1000</span>);
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span><span>        }
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span><span>    }
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span><span>}
</span></span></code></pre></div><p>As you can see we have defined a method called <code>Execute</code> which accepts a parameter. We have also decorated it with some attributes to control how it&rsquo;s displayed in the Hangfire dashboard or how many times Hangfire would automatically retry the job if it fails.</p>
<p>And this is how you&rsquo;d enqueue the job:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span>_backgroundJobClient.Enqueue&lt;SendEmailsJob&gt;(job =&gt; job.Execute(<span style="color:#40a070">5</span>));
</span></span></code></pre></div><h2 id="scheduling-jobs">Scheduling Jobs</h2>
<p>If you want a job to be executed periodically on a defined schedule, you can write something like this:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span>Hangfire.RecurringJob.AddOrUpdate&lt;SendEmailsJob&gt;(job =&gt; job.Execute(<span style="color:#40a070">10</span>), cronExpression: <span style="color:#4070a0">&#34;*/5 * * * *&#34;</span>);
</span></span></code></pre></div><p><strong>Note:</strong> <code>RecurringJob</code> is a static class.</p>
<p>The job can be a simple expression or a class. And you define the schedule using a Cron Expression. You can construct Cron expressions through sites like <a href="https://crontab.cronhub.io/">this</a> and <a href="https://crontab.guru/">this</a>.</p>
<img src="/assets/images/posts/background-job-scheduling-using-hangfire/job.jpg" width="800">
<h2 id="extensions">Extensions</h2>
<p>Hangfire has a lot of extensions, you can check them out <a href="https://www.hangfire.io/extensions.html">here</a>. But my favorite extension is this one. Which lets you output real time logs :)</p>
<img src="https://github.com/pieceofsummer/Hangfire.Console/raw/master/dashboard.png" width="600" />
<p><strong>Note:</strong> The console is not real-time if you use SQLite as the storage engine.</p>
<h2 id="source-code">Source code</h2>
<p>I have put a sample application <a href="https://github.com/mhmd-azeez/HangfireDemo">here </a> which contains the codes in this article and the rest of the ASP.NET Core app.</p>

</content>



<p>
  
  <a href="http://localhost:1313/tags/hangfire/">#hangfire</a>

  
</p>



<section class="related-posts">
  <h3>Keep reading</h3>
  <ul>
    
    <li>
      <a href="http://localhost:1313/posts/csproj-include-folders-recursively/">How to include folders as link recursively in csproj files</a>
      <span class="related-posts__date">
        13 Oct, 2020
      </span>
    </li>
    
    <li>
      <a href="http://localhost:1313/posts/github-party-trick/">GitHub Party Trick</a>
      <span class="related-posts__date">
        25 Aug, 2020
      </span>
    </li>
    
    <li>
      <a href="http://localhost:1313/posts/csharp-source-generators/">Use C# Source Generators to make all of your methods async!</a>
      <span class="related-posts__date">
        05 May, 2020
      </span>
    </li>
    
    <li>
      <a href="http://localhost:1313/posts/update-sideloaded-uwp-2/">&#39;Enabling automatic updates for sideloaded UWP apps: Multiple update channels&#39;</a>
      <span class="related-posts__date">
        25 Apr, 2020
      </span>
    </li>
    
  </ul>
</section>


  </main>
  <footer><div class="footer-links">
  <a href="/">Home</a> · <a href="/about/">About</a>
</div>
<div class="footer-credit">Made with <a href="https://github.com/janraasch/hugo-bearblog/">Hugo ʕ•ᴥ•ʔ Bear</a></div>
</footer>

  
</body>

</html>

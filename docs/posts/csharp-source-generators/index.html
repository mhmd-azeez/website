<!DOCTYPE html>
<html lang="en-us">

<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
  <meta http-equiv="X-Clacks-Overhead" content="GNU Terry Pratchett" />
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
<link rel="shortcut icon" href="http://localhost:1313/favicon.ico" />
<title>Use C# Source Generators to make all of your methods async! | Muhammad Azeez</title>
<meta name="title" content="Use C# Source Generators to make all of your methods async!" />
<meta name="description" content="C# Source Generators is a C# 9 feature that lets your generate source code during build. For more information read the announcement blog post on .NET blog.

NOTE: If it&rsquo;s not clear, this post is satire. Don&rsquo;t use any of the code or suggestions in production.

Have you ever had problems with app speed? Well, the easiest way to speed up your app is to make your methods async. And the easiest way of making your methods async is by using Task.Run." />
<meta name="keywords" content="csharp,source-generators," />


<meta property="og:url" content="http://localhost:1313/posts/csharp-source-generators/">
  <meta property="og:site_name" content="Muhammad Azeez">
  <meta property="og:title" content="Use C# Source Generators to make all of your methods async!">
  <meta property="og:description" content="C# Source Generators is a C# 9 feature that lets your generate source code during build. For more information read the announcement blog post on .NET blog.
NOTE: If it’s not clear, this post is satire. Don’t use any of the code or suggestions in production.
Have you ever had problems with app speed? Well, the easiest way to speed up your app is to make your methods async. And the easiest way of making your methods async is by using Task.Run.">
  <meta property="og:locale" content="en_us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2020-05-05T00:00:00+00:00">
    <meta property="article:modified_time" content="2020-05-05T00:00:00+00:00">
    <meta property="article:tag" content="Csharp">
    <meta property="article:tag" content="Source-Generators">
    <meta property="og:image" content="http://localhost:1313/assets/images/cover.jpg">




  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:image" content="http://localhost:1313/assets/images/cover.jpg">
  <meta name="twitter:title" content="Use C# Source Generators to make all of your methods async!">
  <meta name="twitter:description" content="C# Source Generators is a C# 9 feature that lets your generate source code during build. For more information read the announcement blog post on .NET blog.
NOTE: If it’s not clear, this post is satire. Don’t use any of the code or suggestions in production.
Have you ever had problems with app speed? Well, the easiest way to speed up your app is to make your methods async. And the easiest way of making your methods async is by using Task.Run.">




  <meta itemprop="name" content="Use C# Source Generators to make all of your methods async!">
  <meta itemprop="description" content="C# Source Generators is a C# 9 feature that lets your generate source code during build. For more information read the announcement blog post on .NET blog.
NOTE: If it’s not clear, this post is satire. Don’t use any of the code or suggestions in production.
Have you ever had problems with app speed? Well, the easiest way to speed up your app is to make your methods async. And the easiest way of making your methods async is by using Task.Run.">
  <meta itemprop="datePublished" content="2020-05-05T00:00:00+00:00">
  <meta itemprop="dateModified" content="2020-05-05T00:00:00+00:00">
  <meta itemprop="wordCount" content="523">
  <meta itemprop="image" content="http://localhost:1313/assets/images/cover.jpg">
  <meta itemprop="keywords" content="Csharp,Source-Generators">
<meta name="referrer" content="no-referrer-when-downgrade" />

  <style>
  :root {
    --width: 720px;
    --font-main: Verdana, sans-serif;
    --font-secondary: Verdana, sans-serif;
    --font-scale: 1em;
    --background-color: #fff;
    --heading-color: #222;
    --text-color: #444;
    --link-color: #3273dc;
    --visited-color: #8b6fcb;
    --blockquote-color: #222;
  }

  @media (prefers-color-scheme: dark) {
    :root {
      --background-color: #01242e;
      --heading-color: #eee;
      --text-color: #ddd;
      --link-color: #8cc2dd;
      --visited-color: #8b6fcb;
      --blockquote-color: #ccc;
    }
  }

  body {
    font-family: var(--font-secondary);
    font-size: var(--font-scale);
    margin: auto;
    padding: 20px;
    max-width: var(--width);
    text-align: left;
    background-color: var(--background-color);
    word-wrap: break-word;
    overflow-wrap: break-word;
    line-height: 1.5;
    color: var(--text-color);
  }

  h1,
  h2,
  h3,
  h4,
  h5,
  h6 {
    font-family: var(--font-main);
    color: var(--heading-color);
  }

  a {
    color: var(--link-color);
    cursor: pointer;
    text-decoration: none;
  }

  a:hover {
    text-decoration: underline;
  }

  nav a {
    margin-right: 8px;
  }

  strong,
  b {
    color: var(--heading-color);
  }

  button {
    margin: 0;
    cursor: pointer;
  }

  time {
    font-family: monospace;
    font-style: normal;
    font-size: 15px;
  }

  main {
    line-height: 1.6;
  }

  table {
    width: 100%;
  }

  hr {
    border: 0;
    border-top: 1px dashed;
  }

  img {
    max-width: 100%;
  }

  code {
    font-family: monospace;
    padding: 2px;
    border-radius: 3px;
  }

  blockquote {
    border-left: 1px solid #999;
    color: var(--blockquote-color);
    padding-left: 20px;
    font-style: italic;
  }

  footer {
    padding: 25px 0;
    text-align: center;
  }

  .title:hover {
    text-decoration: none;
  }

  .title h1 {
    font-size: 1.5em;
  }

  .inline {
    width: auto !important;
  }

  .highlight,
  .code {
    border-radius: 3px;
    margin-block-start: 1em;
    margin-block-end: 1em;
    overflow-x: auto;
  }

   
  ul.blog-posts {
    list-style-type: none;
    padding: unset;
  }

  ul.blog-posts li {
    display: flex;
  }

  ul.blog-posts li span {
    flex: 0 0 130px;
  }

  ul.blog-posts li a:visited {
    color: var(--visited-color);
  }

</style>
<link rel="stylesheet" href="/assets/css/highlight.css">
<link rel="stylesheet" href="/assets/css/override.css">
<script defer src="https://cdn.jsdelivr.net/npm/chart.js@4.4.6/dist/chart.umd.min.js"></script>
</head>

<body>
  <header><div class="site-brand site-brand--inline">
  <a href="/" class="title">
    <h2>Muhammad Azeez</h2>
  </a>
  <nav class="site-nav"><a href="/">Home</a>
<a href="/about/">About</a>
</nav>
</div>
</header>
  <main>
<h1>Use C# Source Generators to make all of your methods async!</h1>
<p>
  <i>
    <time datetime='2020-05-05'>
      05 May, 2020
    </time>
  </i>
</p>
<content>
  <p>C# Source Generators is a C# 9 feature that lets your generate source code during build. For more information read the <a href="https://devblogs.microsoft.com/dotnet/introducing-c-source-generators/">announcement blog post</a> on .NET blog.</p>
<blockquote>
<p>NOTE: If it&rsquo;s not clear, this post is satire. Don&rsquo;t use any of the code or suggestions in production.</p>
</blockquote>
<p>Have you ever had problems with app speed? Well, the easiest way to speed up your app is to make your methods async. And the easiest way of making your methods async is by using <code>Task.Run</code>.</p>
<p>For example, if we had a method like this:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span><span style="color:#007020;font-weight:bold">static</span> <span style="color:#007020;font-weight:bold">void</span> PrintNumber(<span style="color:#902000">int</span> number)
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span><span>{
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span><span>    Console.WriteLine(number);
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4</span><span>}
</span></span></code></pre></div><p>Let&rsquo;s assume that <code>PrintNumber</code> is slow and we want to speed it up, what do we do? We stick it in Task.Run and voila! all of our problems are solved!</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span><span style="color:#007020;font-weight:bold">static</span> Task PrintNumberAsync(<span style="color:#902000">int</span> number)
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span><span>{
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span><span>    <span style="color:#007020;font-weight:bold">return</span> Task.Run(() =&gt; PrintNumber(number));
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4</span><span>}
</span></span></code></pre></div><p>Okay, how are c# source generators useful here? Well, we can write a source generator that turns all of your methods async just by applying a simple attribute!</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span><span style="color:#007020;font-weight:bold">partial</span> <span style="color:#007020;font-weight:bold">class</span> <span style="color:#0e84b5;font-weight:bold">Program</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span>{
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span>    <span style="color:#007020;font-weight:bold">static</span> <span style="color:#007020;font-weight:bold">async</span> Task Main(<span style="color:#902000">string</span>[] args)
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span>    {
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span>       <span style="color:#007020;font-weight:bold">await</span> PrintNumberAsync(<span style="color:#40a070">42</span>);
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span>    }
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span><span><span style="color:#4070a0">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span><span><span style="color:#4070a0">    [Asyncify]</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span><span>    <span style="color:#007020;font-weight:bold">static</span> <span style="color:#007020;font-weight:bold">void</span> PrintNumber(<span style="color:#902000">int</span> number)
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span><span>    {
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span><span>        Console.WriteLine(number);
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span><span>    }
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span><span>}
</span></span></code></pre></div><p>Notice how <code>Main</code> calls <code>PrintNumberAsync</code> without us needing to define it? That&rsquo;s because there is a source generator that generates the async version of any method that&rsquo;s decorated with the <code>Asyncify</code> attribute.</p>
<p>The source generator is very simple but a little verbose, so I don&rsquo;t include the source code here. But it&rsquo;s available on <a href="https://github.com/encrypt0r/FunWithSourceGenerators">GitHub</a>.</p>
<p>The basic idea is that our source generator asks for any method that has our specific attribute (<code>Asyncify</code>) applied to it.</p>
<p>It then groups the methods by their class, for each class it creates another partial class that contains the async versions for the specified methods.</p>
<p>Here is how we generate each method:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span><span style="color:#007020;font-weight:bold">private</span> <span style="color:#007020;font-weight:bold">void</span> ProcessMethod(StringBuilder source, IMethodSymbol methodSymbol)
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span>{
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span>    <span style="color:#60a0b0;font-style:italic">// SayHello =&gt; SayHelloAsync</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span>    <span style="color:#902000">string</span> asyncMethodName = <span style="color:#4070a0">$&#34;{methodSymbol.Name}Async&#34;</span>;
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span>    <span style="color:#902000">var</span> staticModifier = methodSymbol.IsStatic ? <span style="color:#4070a0">&#34;static&#34;</span> : <span style="color:#902000">string</span>.Empty;
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span><span>    <span style="color:#60a0b0;font-style:italic">// void =&gt; Task, bool =&gt; Task&lt;bool&gt;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span><span>    <span style="color:#902000">var</span> asyncReturnType = methodSymbol.ReturnType.Name == <span style="color:#4070a0">&#34;Void&#34;</span> ? 
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span><span>                          <span style="color:#4070a0">&#34;Task&#34;</span> :
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span><span>                          <span style="color:#4070a0">$&#34;Task&lt;{methodSymbol.ReturnType.Name}&gt;&#34;</span>;
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span><span>    <span style="color:#60a0b0;font-style:italic">// int number, string name</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span><span>    <span style="color:#902000">var</span> parameters = <span style="color:#902000">string</span>.Join(<span style="color:#4070a0">&#34;,&#34;</span>, methodSymbol.Parameters.Select(p =&gt; <span style="color:#4070a0">$&#34;{p.Type} {p.Name}&#34;</span>));
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span><span>    <span style="color:#60a0b0;font-style:italic">// number, name</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span><span>    <span style="color:#902000">var</span> arguments = <span style="color:#902000">string</span>.Join(<span style="color:#4070a0">&#34;,&#34;</span>, methodSymbol.Parameters.Select(p =&gt; p.Name));
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span><span>    source.Append(<span style="color:#4070a0">$@&#34;
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span><span><span style="color:#4070a0">public {staticModifier} {asyncReturnType} {asyncMethodName}({parameters})
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span><span><span style="color:#4070a0">{{
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span><span><span style="color:#4070a0">    return Task.Run(() =&gt; {methodSymbol.Name}({arguments}));
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22</span><span><span style="color:#4070a0">}}
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23</span><span><span style="color:#4070a0">&#34;</span>);
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24</span><span>}
</span></span></code></pre></div><p>Because C# Source Generators are part of build, we get a lot metadata (like <a href="https://docs.microsoft.com/en-us/dotnet/api/microsoft.codeanalysis.imethodsymbol?view=roslyn-dotnet">IMethodSymbol</a>) about all of the classes, methods, fields, etc. It&rsquo;s like reflection, but in compile time. If you have experience with Analyzers it&rsquo;s very similar because they are both based on Roslyn. But unlike Analyzers, C# Source Generators emit code using strings, not syntax tree deltas. To be honest, I like the string approach. It&rsquo;s a lot more friendly. However, it can get hard to maintain for complicated scenarios.</p>
<p>To make our source generator even more useful, we can modify it so that we can apply the <code>Asyncify</code> attribute on a class and all of the methods of the class get asyncified! I&rsquo;ll leave that as an exercise.</p>

</content>



<p>
  
  <a href="http://localhost:1313/tags/csharp/">#csharp</a>

  
  <a href="http://localhost:1313/tags/source-generators/">#source-generators</a>

  
</p>



<section class="related-posts">
  <h3>Keep reading</h3>
  <ul>
    
    <li>
      <a href="http://localhost:1313/posts/csproj-include-folders-recursively/">How to include folders as link recursively in csproj files</a>
      <span class="related-posts__date">
        13 Oct, 2020
      </span>
    </li>
    
    <li>
      <a href="http://localhost:1313/posts/chat-gpt-csharp-bindings/">Generating C# bindings for native libraries by using ChatGPT</a>
      <span class="related-posts__date">
        17 Dec, 2022
      </span>
    </li>
    
    <li>
      <a href="http://localhost:1313/posts/how-orms-work/">How do Object Relational Mappers (like Entity Framework) work?</a>
      <span class="related-posts__date">
        21 Dec, 2019
      </span>
    </li>
    
    <li>
      <a href="http://localhost:1313/posts/csharp-yield/">How the C# yield keyword works</a>
      <span class="related-posts__date">
        20 May, 2019
      </span>
    </li>
    
  </ul>
</section>


  </main>
  <footer><div class="footer-links">
  <a href="/">Home</a> · <a href="/about/">About</a>
</div>
<div class="footer-credit">Made with <a href="https://github.com/janraasch/hugo-bearblog/">Hugo ʕ•ᴥ•ʔ Bear</a></div>
</footer>

  
</body>

</html>
